---
title: "COSEWIC Pacific salmon DU probabale status'"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
    keep_md: false
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```
# About
This document summarizes estimates of change in mature individuals over time for Pacific salmon Designatable Unit (DU) and associated  probable COSEWIC status designation. Data sources are detailed [here](https://github.com/Pacific-salmon-assess/COSEWIC-prioritize#data-sources) and all code to reproduce the analyses in this document is [here](https://github.com/Pacific-salmon-assess/COSEWIC-prioritize). These materials are solely intended to support the Marine Fishes sub-committee of COSEWIC in identifying high priority DUs for COSEWIC to consider when conducting formal status assessments.

# Prioritization decison nodes
Initial thoughts on potential decision nodes in the prioritization process. 

#. **Have DUs been formally defined by COSEWIC?** Chinook, sockeye, and coho salmon DUs have been defined (reports available [here](https://www.cosewic.ca/index.php/en-ca/reports/special-reports.html)), formal pink and chum DU identification is in progress. If **yes** then proceed. 

#. **Is information on mature individuals over time available at the DU scale?** If **yes** then proceed.

#. **Has DU been previously assessed by COSEWIC?** If **yes** then consider a re-assessment, otherwise proceed.

#. **What is the DUs probable designation based on percentage change in mature individuals over past three generations?** If **special concern**,  **threatened** or **endangered** then proceed.

#. **Are there spatial considerations?** Are there commonalities in threats, designations, and/or data landscape at a regional scale that suggest a group of DUs should be bundled together?  

```{r setup, include=FALSE}
# libraries and global settings ----
library(tidyverse)
library(DT)

knitr::opts_chunk$set(echo = FALSE, message=FALSE, cache=FALSE, include=TRUE, dpi=300)
options(scipen=1, digits=4)

# read in data ----
raw_sp_data <- read.csv("./data/CU_Spawner_Abund_20220809.csv", 
                        header=TRUE) %>%
  mutate(logSp=log(Spawner.Abundance))

cu_metadata <- read.csv("./data/CU_Metadata_20220809.csv",  
                        header=TRUE, na.strings=c("", "NA")) %>%
  filter(!is.na(gen_length)) %>%
  rename(CUID=cuid)

# join, dump pops with NA DUs ----
sp_data <- left_join(raw_sp_data, select(cu_metadata, Region, CUID, du_number, gen_length, Sites, cu_enh_rank, COSEWIC_status, spp), 
                     by="CUID") %>%
  drop_na(du_number, Spawner.Abundance) %>%
  mutate(Species = spp) %>%
  group_by(du_number, Region.y, Year, gen_length, Sites, cu_enh_rank, COSEWIC_status, Species) %>%
  rename(Region = Region.y) %>%
  summarise(mat_ind = sum(Spawner.Abundance))%>%
  arrange(du_number, Year)

# filter to DUs with spawner estimates in at least 50% of last three generations (and 20% of all years) ----
last3_gens <- sp_data %>%
  group_by(du_number) %>%
  mutate(three_gens = gen_length*3) %>%
  filter(Year > (last(Year) - three_gens), Year <= last(Year))

deficient_recent_perc <- 0.5

deficient_recent <- last3_gens %>%
  group_by(du_number) %>%
  summarise(n = n(), #years with data  
            n_proper = mean(gen_length)*3) %>% # years for 3 gens of data if fully sampled
  mutate(perc_na = n/n_proper) %>%
  filter(perc_na < deficient_recent_perc) %>%
  pull(du_number)

last3_gens_filtered <- filter(last3_gens, !(du_number %in% deficient_recent))

deficient_historical_perc <- 0.2

deficient_historical <- sp_data %>%
  group_by(du_number) %>%
  summarise(n = n(),
            n_proper = last(Year) - first(Year) + 1) %>%
  mutate(perc_na = n/n_proper) %>%
  filter(perc_na < deficient_historical_perc) %>%
  pull(du_number)

sp_data_filtered <- filter(sp_data, !(du_number %in% deficient_historical))
```

```{r models, include=FALSE}
# estimates rate of change using simple lm ----
summary_table <- NULL

for(i in unique(sp_data_filtered$du_number)){
  sub_raw <- filter(sp_data, du_number==i)
  sub_data <- filter(sp_data_filtered, du_number==i)
  sub_last3 <- filter(last3_gens_filtered, du_number==i)
  if(nrow(sub_data)==0){
    slope_all <- NA
  } else{
    if(nrow(sub_last3)==0){
      slope_recent <- NA
    } else{
      model_all <- lm(log(sub_data$mat_ind)~sub_data$Year)
      model_recent <- lm(log(sub_last3$mat_ind)~sub_last3$Year)
      per_change_all <- round(as.numeric((exp(model_all$coefficients[2]*(3*unique(sub_data$gen_length)))-1)*100))
      per_change_recent <- round(as.numeric((exp(model_recent$coefficients[2]*(3*unique(sub_data$gen_length)))-1)*100))
    }
  }
  recent_abundance <- last(sub_raw$mat_ind)
  last_year_monitored <- last(sub_raw$Year)
  
  output <- data.frame(du_number=i, Region = unique(sub_raw$Region), per_change_recent, per_change_all, recent_abundance, last_year_monitored)
  
  summary_table <- bind_rows(output, summary_table)
}

# assess probable designation, rename a couple of regions ----
prob_desg <- summary_table %>%
  mutate(prob_designation_recent = case_when(
    per_change_recent  > -29 ~ "Not at risk",
    per_change_recent < -29 & per_change_recent > -49 ~ "Special concern",
    per_change_recent < -49 & per_change_recent > -69 ~ "Threatened",
    per_change_recent < -69 ~ "Endangered")) %>%
  mutate(prob_designation_all = case_when(
    per_change_all  > -29 ~ "Not at risk",
    per_change_all < -29 & per_change_all > -49 ~ "Special concern",
    per_change_all < -49 & per_change_all > -69 ~ "Threatened",
    per_change_all < -69 ~ "Endangered"))

master_desg <- left_join(cu_metadata, select(prob_desg, Region, du_number, per_change_recent, per_change_all, recent_abundance, last_year_monitored, prob_designation_recent,prob_designation_all), 
                     by="du_number") %>%
  mutate(COSEWIC_status = ifelse(is.na(COSEWIC_status), "Not assessed", COSEWIC_status)) %>%
  rename(Region = Region.x) %>%
  mutate(region_full = case_when(
    Region == "HG" ~ "Haida Gwaii",
    Region == "CC" ~ "Central Coast",
    Region == "VIMI" ~ "Van. Isl. Main. Inl.",
    TRUE ~ Region))

# wrangle assessed and un-assessed status'
assessed <- master_desg %>%
  filter(COSEWIC_status != "Not assessed")

not_assessed <- master_desg %>%
  filter(COSEWIC_status == "Not assessed") %>%
  mutate(prob_designation_recent = ifelse(is.na(prob_designation_recent), "Data defficient", 
                                          prob_designation_recent),
         prob_designation_all = ifelse(is.na(prob_designation_all), "Data defficient", 
                                          prob_designation_all))

designations <- rbind(assessed,not_assessed)%>%
  mutate(species = spp) %>%
  select(region_full, du_number,species, gen_length, COSEWIC_status,per_change_recent, per_change_all, recent_abundance, last_year_monitored, prob_designation_recent)%>%
  arrange(du_number)%>%
  distinct(du_number,.keep_all = TRUE)

unassessed <- designations %>%
  filter(COSEWIC_status == "Not assessed",
         prob_designation_recent != "Data defficient")

write.csv(designations, "./output/master-prob-status/master_status.csv")

NA_regions <- filter(designations, is.na(region_full))
```

# Probable status summary 
## Unassessed DUs
```{r summary-status-recent, echo=FALSE, fig.align = "center", out.width = '90%'}
# summarize probable status by spp and region ----
count_bins <- unassessed %>%
  group_by(species, region_full) %>%
  summarize(du_count=n())

count_bins_status <- unassessed %>%
  group_by(species, region_full, prob_designation_recent) %>%
  summarize(du_count=n()) %>%
  mutate(prob_designation_recent = factor(prob_designation_recent, levels = rev(c("Endangered","Threatened", "Special concern", "Not at risk"))), 
         region_full = factor(region_full, levels = c("Yukon", "Nass","Skeena", "Haida Gwaii", "Central Coast", "Van. Isl. Main. Inl.", "Fraser")))

count_bins_status[37,4] <- 1 # hard code Fraser pinks which have 8 DUs but only one CU

# plot probable status by spp and region ----
ggplot(count_bins_status, aes(x = species, y = du_count)) + 
  geom_col(aes(fill=prob_designation_recent)) +
  facet_wrap(~region_full, scales="free_y", ncol=4) +
  scale_fill_manual(values = c("dark green", "yellow", "orange","red")) +
  xlab("Species") +
  ylab("Number of DUs") +
  labs(fill = "Probable designation") +
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1), legend.position = "top")
```
**Figure 1**. Probable status of previously unassesed Pacific salmon DUs based on rate of change in mature individuals over most recent three generations. 

# Summary table

## Summary table all DUs  
```{r, warning = FALSE}
colnames(designations) <- c("Region", "DU", "Species", "Generation length", "COSEWIC status", "% Change (recent)", "% Change (all)", "Recent abundance", "Last year", "Probable status")

#switch characters to factor to make dropdown filtering
designations <- designations %>%
  mutate(Region = as.factor(Region), 
         DU = as.factor(DU), 
         Species = as.factor(Species),
         `COSEWIC status` = as.factor(`COSEWIC status`),
         `Probable status` = as.factor(`Probable status`))
  
datatable(designations, rownames = FALSE, 
          caption = 'Table 1: Estimates of percent change in mature individual (spawner) abundance over most recent three generations (based on just last three generations or all years of observations) for Pacific Salmon DUs in the Pacific region. Also shown are the region, average generation length, COSEWIC status if previously assessed, mature individual abundance over most recent generation, the last year with data and probable COSEWIC designation based on percent change based on just the last three generations of observations.',
          filter = 'top', 
          options = list(pageLength = 20, autoWidth = TRUE))
```

# Abundance plots  
```{r abundance plots, warning = FALSE, results= 'asis'}
#note: `asis` argument is necessary to properly render headers with cat() below

raw_sp_data <- raw_sp_data %>%
  mutate(logSp=log(Spawner.Abundance))


sp_data <- left_join(raw_sp_data, select(cu_metadata, CUID, du_number, gen_length), 
                     by="CUID") %>%
  drop_na(du_number, Spawner.Abundance) %>%
  mutate(du_cu=paste(du_number, CUID)) %>%
  relocate(du_cu, 1) %>%
  arrange(du_cu, Year) %>%
  mutate(Region = case_when(Region == "HG" ~ "Haida Gwaii",
                                 Region == "CC" ~ "Central Coast",
                                 Region == "VIMI" ~ "Van. Isl. Main. Inl.", 
                                 TRUE ~ Region))

last3_gens <- sp_data %>%
  group_by(du_cu) %>%
  mutate(three_gens = gen_length*3) %>%
  filter(Year > (last(Year) - three_gens), Year <= last(Year))

max_facets <- 20 #how many facets (i.e. panes) per plot?
rows <- 4 #how many rows/cols? note needs to be multiple of facets. 
cols <- 5

for(i in unique(sp_data$Region)){
  sp_data_region <- filter(sp_data, Region==i)
  
   cat('\n')  
   cat("## ", i, "\n") #nested region header
   
  for(j in unique(sp_data_region$Species)){
    sub_data <- filter(sp_data_region, Species==j) %>%
      complete(Year, Species, Region, du_cu) #explicitly include NA so line draws right
    
    cat('\n')  
    cat("### ", j, "\n") #nested species within region header
    
    sub_last3 <- filter(last3_gens, Region==i, Species==j)
    n_pops <- length(unique(sub_data$du_cu))
    if( n_pops>max_facets){
      pages <- ceiling(n_pops/max_facets)
    for(k in 1:pages){
      sub_data_2 <- filter(sub_data, du_cu %in% 
                               unique(sub_data$du_cu)[((k-1)*max_facets)+1:(max_facets*k)])
      
      sub_last3_2 <- filter(sub_last3, du_cu %in% 
                                unique(sub_last3$du_cu)[((k-1)*max_facets)+1:(max_facets*k)])
      
      p <- ggplot(data = sub_data_2, aes(x=Year, y=Spawner.Abundance/1000)) +
        geom_line(color="grey") +
        geom_point() +
        ggh4x::facet_wrap2(vars(du_cu), nrow=rows, ncol=cols, trim_blank=FALSE,
                           scales="free_y") +
        labs(x="Year", y="spawners (thousands)", 
             title = paste0(i," ",j," spawner abundance ","(",k," of ",pages,")")) +
        theme_bw() +
        theme(strip.background=element_blank(), axis.text.x=element_text(angle = 45))
      print(p)
      
      p_log <- ggplot(data=sub_data_2, aes(x=Year, y=logSp)) +
        geom_line(color="grey") +
        geom_point() +
        stat_smooth(method="lm", formula=y~x, color="black", lty="dashed", se=FALSE) +
        stat_smooth(data = sub_last3_2, formula=y~x, method="lm", color="red", se=FALSE, 
                    na.rm=TRUE) +
        ggh4x::facet_wrap2(vars(du_cu), nrow=rows, ncol=cols, trim_blank=FALSE,
                           scales="free_y") +
        labs(x="Year", y="ln(spawners)", 
             title=paste0("ln ",i," ",j," spawner abundance ","(",k," of ",pages,")")) +
        theme_bw() +
        theme(strip.background=element_blank(), axis.text.x=element_text(angle=45))
      print(p_log)
    }
  }else{
    p <- ggplot(data=sub_data, aes(x=Year, y=Spawner.Abundance/1000)) +
      geom_line(color="grey") +
      geom_point() +
      ggh4x::facet_wrap2(vars(du_cu), nrow=rows, ncol=cols, trim_blank=FALSE, 
                         scales="free_y") +
      labs(x="Year", y="spawners (thousands)", title=paste(i, j, "spawner abundance")) +
      theme_bw() +
      theme(strip.background=element_blank(), axis.text.x=element_text(angle = 45))
    print(p)
    
    p_log <- ggplot(data=sub_data, aes(x=Year, y=logSp)) +
      geom_line(color="grey") +
      geom_point() +
      stat_smooth(formula=y~x, method="lm", color="black", lty="dashed", se=FALSE) +
      stat_smooth(data=sub_last3, formula=y~x, method="lm", color="red", se=FALSE, 
                  na.rm=TRUE) +
      ggh4x::facet_wrap2(vars(du_cu), nrow=rows, ncol=cols, trim_blank=FALSE, 
                         scales="free_y") +
      labs(x="Year", y="ln(spawners)", title=paste(i, j, "ln(spawner abundance)")) +
      theme_bw() +
      theme(strip.background=element_blank(), axis.text.x=element_text(angle = 45))
    print(p_log)
  }
        cat('\n')  

  }
      cat('\n') 

}
```

# Posterior Estimates of Population Decline
We will also use the [MetricsCOSEWIC package](https://github.com/SOLV-Code/MetricsCOSEWIC) to fit Bayesian estimates of the probability of population decline, then plot posteriors to see the distribution of declines. 
Thresholds for population decline based on [category A2](https://www.canada.ca/en/environment-climate-change/services/species-risk-act-accord-funding/listing-process/quantitative-criteria-guidelines-status-table-2.html), where 50 and 30 percent reductions correspond to endangered and threatened status, respectively. we'll use 30, 50, and 70 % reductions as thresholds for least concern, threatened, and endangered for now.  

```{r, metricsCOSEWIC, include = FALSE}
library(MetricsCOSEWIC)

slope_posterior <- NULL
jags_summary <- NULL

#fix region names
last3_gens_filtered <- last3_gens_filtered %>%
  mutate(Region = case_when(Region == "HG" ~ "Haida Gwaii",
                            Region == "CC" ~ "Central Coast",
                            Region == "VIMI" ~ "Van. Isl. Main. Inl.", 
                            TRUE ~ Region))

for(i in unique(last3_gens_filtered$du_number)){
  sub_data <- filter(last3_gens_filtered, du_number == i)
  jags_mod <- calcPercChangeMCMC(sub_data$mat_ind, method="jags", out.type="long") 
  
  summary <- data.frame(jags_mod$summary) %>%
    slice(1:3) %>%
    select(mean, sd, X2.5., X50., X97.5., n.eff, Rhat) %>%
    rename(perc_2.5 = X2.5., 
           perc_97.5 = X97.5.,
           median = X50.) %>%
    mutate(du_number = i,
           Species = sub_data$Species[1],
           Region = sub_data$Region[1]) %>%
    relocate(du_number, Region, Species, .before = mean) 
  
  rownames(summary) <- NULL #rownames to columns - probably a better way
  summary$var <- c("intercept", "slope", "sigma")

  jags_summary <- bind_rows(summary, jags_summary)

  slope_posterior <- bind_rows(data.frame(du_number =i, Region = unique(sub_data$Region),
                                          Species = unique(sub_data$Species),
                                          draw = jags_mod$samples$slope), slope_posterior)
}

jags_summary <- relocate(jags_summary, var, .before = mean)

perc_category <- slope_posterior %>%
  group_by(Species, Region, du_number) %>%
  summarise(not_at_risk = round(sum(draw>(-30))/n()*100, 2),
            least_concern = round(sum((-30)>draw & draw>(-50))/n()*100, 2), 
            threatened = round(sum(draw<(-50) & draw>(-70))/n()*100, 2), 
            endangered = round(sum(draw<(-70))/n()*100, 2))
```

```{r compare with lm, include = FALSE}
#we'll check that these bayesian slope estimates align with simple lm()s earlier
lm_slopes <- summary_table %>%
  rename(lm_slope = per_change_recent) %>%
  select(du_number, lm_slope)

compare_declines <- jags_summary %>%
  filter(var == "slope") %>%
  rename(jags_slope_median = median) %>%
  select(du_number, jags_slope_median) %>%
  left_join(., lm_slopes, by = "du_number") 
```

```{r, plot slope posteriors, results = 'asis'}

#helper function to center limits
symmetric_limits <- function(x){
    max <- max(abs(x))
    c(-max, max)
}

for(i in unique(slope_posterior$Region)){
  post_region <- filter(slope_posterior, Region == i)
  
  cat('\n')  
  cat("## ", i, "\n") #nested region header
   
  for(j in unique(post_region$Species)){
    sub_data <- filter(post_region, Species == j)
    
    cat('\n')  
    cat("### ", j, "\n") #nested species within region header
    
    if(length(unique(sub_data$du_number)) > max_facets){
      pages <- ceiling(length(unique(sub_data$du_number))/max_facets)
    for(k in 1:pages){
      sub_data_2 <- filter(sub_data, du_number %in% 
                               unique(sub_data$du_number)[((k-1)*max_facets)+1:(max_facets*k)])
      p <- ggplot(data = sub_data_2, aes(draw)) +
        geom_density(fill = "gray") + 
        scale_x_continuous(limits = symmetric_limits) +
        geom_rect(aes(xmin=-30, xmax=Inf, ymin=0, ymax= Inf), fill="green", alpha=0.002) +
        geom_rect(aes(xmin=-50 , xmax=-30, ymax=Inf, ymin=-Inf), fill="yellow", alpha=0.002) +
        geom_rect(aes(xmin=-70, xmax=-50, ymax=Inf, ymin=-Inf), fill="orange", alpha=0.002) +
        geom_rect(aes(xmin=-Inf, xmax=-70, ymax=Inf, ymin=-Inf), fill="red", alpha=0.002) +
        theme_classic() +
        ggh4x::facet_wrap2(vars(du_number), nrow=rows, ncol=cols, trim_blank=FALSE, 
                           scales="free") +
        labs(title = paste(i, j, "slope posterior", "(", k, " of ", pages, ")"), 
         x = "MCMC draws") +
        guides(x = "none", y = "none")
      print(p)
    }
  }else{
      p <- ggplot(data = sub_data, aes(draw)) +
        geom_density(fill = "gray") + 
        scale_x_continuous(limits = symmetric_limits) +
        geom_rect(aes(xmin=-30, xmax=Inf, ymin=0, ymax= Inf), fill="green", alpha=0.002) +
        geom_rect(aes(xmin=-50 , xmax=-30, ymax=Inf, ymin=-Inf), fill="yellow", alpha=0.002) +
        geom_rect(aes(xmin=-70, xmax=-50, ymax=Inf, ymin=-Inf), fill="orange", alpha=0.002) +
        geom_rect(aes(xmin=-Inf, xmax=-70, ymax=Inf, ymin=-Inf), fill="red", alpha=0.002) +
        theme_classic() +
        ggh4x::facet_wrap2(vars(du_number), nrow=rows, ncol=cols, trim_blank=FALSE, 
                           scales="free") +
        labs(title = paste(i, j, "slope posterior"), x = "MCMC draws") +
        guides(x = "none", y = "none")
      print(p)
  }
    cat('\n')
  }
  cat('\n')
}
```
