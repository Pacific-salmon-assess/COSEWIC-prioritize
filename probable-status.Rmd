---
title: "COSEWIC Pacific salmon DU probabale status"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
    keep_md: true
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
</style>
```
This document summarizes Pacific salmon Designatable Unit (DU) rates of change in mature individuals and probable COSEWIC status designation to support Marine Fishes sub-committee prioritization of DUs for formal COSEWIC status assessments.

```{r setup, include=FALSE}
# libraries and global settings ----
library(tidyverse)
library(kableExtra) #perhaps redundant after we incorporate DT?
library(DT)


knitr::opts_chunk$set(echo = FALSE, message=FALSE, cache=FALSE, include=TRUE)
knitr::opts_chunk$set(dpi=300)
options(scipen=1, digits=4)

# read in data ----
raw_sp_data <- read.csv("./data/CU_Spawner_Abund_20220725.csv", 
                        header=TRUE) %>%
  mutate(logSp=log(Spawner.Abundance))

cu_metadata <- read.csv("./data/CU_Metadata_20220725.csv",  
                        header=TRUE, na.strings=c("", "NA")) %>%
  filter(!is.na(gen_length)) %>%
  rename(CUID=cuid)

# join, dump pops with NA DUs ----
sp_data <- left_join(raw_sp_data, select(cu_metadata, CUID, du_number, gen_length, Sites, cu_enh_rank, COSEWIC_status, spp), 
                     by="CUID") %>%
  drop_na(du_number, Spawner.Abundance) %>%
  mutate(Species = spp) %>%
  group_by(du_number, Region, Year, gen_length, Sites, cu_enh_rank, COSEWIC_status, Species) %>%
  summarise(mat_ind = sum(Spawner.Abundance))%>%
  arrange(du_number, Year)

# filter to DUs with spawner estimates in at least 50% of last three generations (and 20% of all years) ----
last3_gens <- sp_data %>%
  group_by(du_number) %>%
  mutate(three_gens = gen_length*3) %>%
  filter(Year > (last(Year) - three_gens), Year <= last(Year))

deficient_recent_perc <- 0.5

deficient_recent <- last3_gens %>%
  group_by(du_number) %>%
  summarise(n = n(), #years with data  
            n_proper = mean(gen_length)*3) %>% # years for 3 gens of data if fully sampled
  mutate(perc_na = n/n_proper) %>%
  filter(perc_na < deficient_recent_perc) %>%
  pull(du_number)

last3_gens_filtered <- filter(last3_gens, !(du_number %in% deficient_recent))

deficient_historical_perc <- 0.2

deficient_historical <- sp_data %>%
  group_by(du_number) %>%
  summarise(n = n(),
            n_proper = last(Year) - first(Year) + 1) %>%
  mutate(perc_na = n/n_proper) %>%
  filter(perc_na < deficient_historical_perc) %>%
  pull(du_number)

sp_data_filtered <- filter(sp_data, !(du_number %in% deficient_historical))
```

```{r models, include=FALSE}
# estimates rate of change using simple lm ----
summary_table <- NULL

for(i in unique(sp_data_filtered$du_number)){
  sub_raw <- filter(sp_data, du_number==i)
  sub_data <- filter(sp_data_filtered, du_number==i)
  sub_last3 <- filter(last3_gens_filtered, du_number==i)
  if(nrow(sub_data)==0){
    slope_all <- NA
  } else{
    if(nrow(sub_last3)==0){
      slope_recent <- NA
    } else{
      model_all <- lm(log(sub_data$mat_ind)~sub_data$Year)
      model_recent <- lm(log(sub_last3$mat_ind)~sub_last3$Year)
      per_change_all <- round(as.numeric((exp(model_all$coefficients[2]*(3*unique(sub_data$gen_length)))-1)*100))
      per_change_recent <- round(as.numeric((exp(model_recent$coefficients[2]*(3*unique(sub_data$gen_length)))-1)*100))
    }
  }
  recent_abundance <- last(sub_raw$mat_ind)
  last_year_monitored <- last(sub_raw$Year)
  
  output <- data.frame(du_number=i, region = unique(sub_raw$Region), per_change_recent, per_change_all, recent_abundance, last_year_monitored)
  
  summary_table <- bind_rows(output, summary_table)
}

# assess probable designation, rename a couple of regions ----
prob_desg <- summary_table %>%
  mutate(prob_designation_recent = case_when(
    per_change_recent  > -29 ~ "Not at risk",
    per_change_recent < -29 & per_change_recent > -49 ~ "Special concern",
    per_change_recent < -49 & per_change_recent > -69 ~ "Threatened",
    per_change_recent < -69 ~ "Endangered")) %>%
  mutate(prob_designation_all = case_when(
    per_change_all  > -29 ~ "Not at risk",
    per_change_all < -29 & per_change_all > -49 ~ "Special concern",
    per_change_all < -49 & per_change_all > -69 ~ "Threatened",
    per_change_all < -69 ~ "Endangered")) %>%
  mutate(region_full = case_when(
    region == "HG" ~ "Haida Gwaii",
    region == "CC" ~ "Central Coast",
    region == "VIMI" ~ "Van. Isl. Main. Inl.",
    TRUE ~ region))

master_desg <- left_join(cu_metadata, select(prob_desg, region_full, du_number, per_change_recent, per_change_all, recent_abundance, last_year_monitored, prob_designation_recent,prob_designation_all), 
                     by="du_number") %>%
  mutate(COSEWIC_status = ifelse(is.na(COSEWIC_status), "Not assessed", COSEWIC_status))

# wrangle assessed and un-assessed status'
assessed <- master_desg %>%
  filter(COSEWIC_status != "Not assessed")

not_assessed <- master_desg %>%
  filter(COSEWIC_status == "Not assessed") %>%
  mutate(prob_designation_recent = ifelse(is.na(prob_designation_recent), "Data defficient", 
                                          prob_designation_recent),
         prob_designation_all = ifelse(is.na(prob_designation_all), "Data defficient", 
                                          prob_designation_all))

designations <- rbind(assessed,not_assessed)%>%
  mutate(species = spp) %>%
  select(region_full, du_number,species, gen_length, COSEWIC_status,per_change_recent, per_change_all, recent_abundance, last_year_monitored, prob_designation_recent, prob_designation_all)%>%
  arrange(du_number)%>%
  distinct(du_number,.keep_all = TRUE)

unassessed <- designations %>%
  filter(COSEWIC_status == "Not assessed",
         prob_designation_recent != "Data defficient")

write.csv(designations, "./output/master-prob-status/master_status.csv")
```

# Probable status 
## Unassessed probable status
```{r summary-status-recent, echo=FALSE, fig.align = "center", out.width = '90%'}
# summarize probable status by spp and region ----
count_bins <- unassessed %>%
  group_by(species, region_full) %>%
  summarize(du_count=n())

count_bins_status <- unassessed %>%
  group_by(species, region_full, prob_designation_recent) %>%
  summarize(du_count=n()) %>%
  mutate(prob_designation_recent = factor(prob_designation_recent, levels = rev(c("Endangered","Threatened", "Special concern", "Not at risk"))), 
         region_full = factor(region_full, levels = c("Yukon", "Nass","Skeena", "Haida Gwaii", "Central Coast", "Van. Isl. Main. Inl.", "Fraser")))

count_bins_status[37,4] <- 1 # hard code Fraser pinks which have 8 DUs but only one CU

# plot probable status by spp and region ----
ggplot(count_bins_status, aes(x = species, y = du_count)) + 
  geom_col(aes(fill=prob_designation_recent)) +
  facet_wrap(~region_full, scales="free_y", ncol=4) +
  scale_fill_manual(values = c("dark green", "yellow", "orange","red")) +
  xlab("Species") +
  ylab("Number of DUs") +
  labs(fill = "Probable designation") +
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1), legend.position = "top")
```
**Figure 1**. Probable status of previously unassesed Pacific salmon DUs based on rate of change in mature individuals over most recent three generations. 

# Summary table

## Summary table all DUs  
```{r, warning = FALSE}
datatable(designations, rownames = FALSE, 
          caption = 'Table 1: blah, blah, blah',
          filter = 'top', 
          options = list(pageLength = 20))
```