---
title: "Prioritizing Pacific salmon DUs for COSEWIC assessment"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 15px;
  color: Black;
}
</style>
```
# About

This document summarizes estimates of change in mature individuals over time for Pacific salmon Designatable Units (DUs) and associated probable COSEWIC status designations. These estimates are being used to help COSEWIC's Marine Fishes sub-committee identify high priority DUs to recommend for formal status assessments. Data sources are detailed [here](https://github.com/Pacific-salmon-assess/COSEWIC-prioritize#data-sources) and all code to reproduce the analyses in this document is [here](https://github.com/Pacific-salmon-assess/COSEWIC-prioritize). These materials are solely intended to support the Marine Fishes sub-committee of COSEWIC, and may not be appropriate for other applications.

As is inevitable when trying to automate assessments across a large number of population units based on data of from a variety of sources there may be errors and inconsistencies in the information presented. If you notice any please flag them as a github issue.

# Prioritization decision nodes

Initial thoughts on potential decision nodes in the prioritization process.

1.  **Have DUs been formally defined by COSEWIC?** Chinook, sockeye, and coho salmon DUs have been defined (reports available [here](https://www.cosewic.ca/index.php/en-ca/reports/special-reports.html)), formal pink and chum DU identification is in progress. If **yes** then proceed.

2.  **Is information on mature individuals over time available at the DU scale?** If **yes** then proceed.

3.  **Has DU been previously assessed by COSEWIC?** If **yes** then consider a re-assessment, otherwise proceed except for DUs that have already been approved for a status assessment.

4.  **What is the DUs probable designation based on percentage change in mature individuals over past three generations and total number of mature individuals for those DUs with absolute estimates?** If **special concern**, **threatened** or **endangered** then proceed.

5.  **Are there spatial considerations?** Are there commonalities in threats, designations, and/or data landscape at a regional scale that suggest a group of DUs should be bundled together?

```{r setup, include=FALSE}
# libraries and global settings ----
#library(devtools) # Load the devtools package.
#install_github("Pacific-salmon-assess/MetricsCOSEWIC", dependencies = TRUE, build_vignettes = FALSE)
#library(MetricsCOSEWIC) #run lines above if you don't have this pkg
library(tidyverse)
library(DT)

knitr::opts_chunk$set(echo = FALSE, message=FALSE, cache=FALSE, include=TRUE, dpi=300)
options(scipen=1, digits=4)

# read in data ----
raw_sp_data <- read.csv("./data/CU_Spawner_Abund_20230915.csv", 
#raw_sp_data <- read.csv("./data/CU_Spawner_Abund_20230915-alt-Yt.csv", 
                        header=TRUE) %>%
  mutate(logSp=log(Spawner.Abundance))


cu_metadata <- read.csv("./data/CU_Metadata_20230828.csv",  
                        header=TRUE, na.strings=c("", "NA")) %>%
  filter(!is.na(gen_length)) %>%
  rename(CUID=cuid)

# join, dump pops with NA DUs ----
sp_data <- left_join(raw_sp_data, select(cu_metadata, Region, CUID, du_number, gen_length, Sites, cu_enh_rank, COSEWIC_status_2023, spp), 
                     by="CUID") %>%
  drop_na(du_number, Spawner.Abundance) %>%
  mutate(Species = spp) %>%
  group_by(du_number, Region.y, Year, gen_length, Sites, cu_enh_rank, COSEWIC_status_2023, Species) %>%
  rename(Region = Region.y,
         COSEWIC_status = COSEWIC_status_2023) %>%
  summarise(mat_ind = sum(Spawner.Abundance))%>%
  arrange(du_number, Year)

# filter to DUs with spawner estimates in at least 30% of last three generations (and 20% of all years) ----
last3_gens <- sp_data %>%
  group_by(du_number) %>%
  mutate(three_gens = gen_length*3) %>%
  filter(Year > (last(Year) - three_gens), Year <= last(Year))

deficient_recent_perc <- 0.3

deficient_recent <- last3_gens %>%
  group_by(du_number) %>%
  summarise(n = n(), #years with data  
            n_proper = mean(gen_length)*3) %>% # years for 3 gens of data if fully sampled
  mutate(perc_na = n/n_proper) %>%
  filter(perc_na < deficient_recent_perc) %>%
  pull(du_number)

last3_gens_filtered <- filter(last3_gens, !(du_number %in% deficient_recent))

deficient_historical_perc <- 0.2

deficient_historical <- sp_data %>%
  group_by(du_number) %>%
  summarise(n = n(),
            n_proper = last(Year) - first(Year) + 1) %>%
  mutate(perc_na = n/n_proper) %>%
  filter(perc_na < deficient_historical_perc) %>%
  pull(du_number)

sp_data_filtered <- filter(sp_data, !(du_number %in% deficient_historical))
```

```{r models, include=FALSE}
# estimates rate of change using simple lm ----
summary_table <- NULL

for(i in unique(sp_data_filtered$du_number)){
  sub_raw <- filter(sp_data, du_number==i)
  sub_data <- filter(sp_data_filtered, du_number==i)
  sub_last3 <- filter(last3_gens_filtered, du_number==i)
  if(nrow(sub_data)==0){
    slope_all <- NA
  } else{
    if(nrow(sub_last3)==0){
      slope_recent <- NA
    } else{
      model_all <- lm(log(sub_data$mat_ind)~sub_data$Year)
      model_recent <- lm(log(sub_last3$mat_ind)~sub_last3$Year)
      per_change_all <- round(as.numeric((exp(model_all$coefficients[2]*(3*unique(sub_data$gen_length)))-1)*100))
      per_change_recent <- round(as.numeric((exp(model_recent$coefficients[2]*(3*unique(sub_data$gen_length)))-1)*100))
    }
  }
  recent_abundance <- last(sub_raw$mat_ind)
  last_year_monitored <- last(sub_raw$Year)
  
  output <- data.frame(du_number=i, Region = unique(sub_raw$Region), per_change_recent, per_change_all, recent_abundance, last_year_monitored)
  
  summary_table <- bind_rows(output, summary_table)
}

# assess probable designation, rename a couple of regions ----
prob_desg <- summary_table %>%
  mutate(prob_designation_recent = case_when(
    per_change_recent  > -10~ "Not at risk",
    per_change_recent < -10& per_change_recent > -29 ~ "Special concern",
    per_change_recent < -29 & per_change_recent > -49 ~ "Threatened",
    per_change_recent < -49 ~ "Endangered")) %>%
  mutate(prob_designation_all = case_when(
    per_change_all  > -10 ~ "Not at risk",
    per_change_all < -10 & per_change_all > -29 ~ "Special concern",
    per_change_all < -29 & per_change_all > -49 ~ "Threatened",
    per_change_all < -49 ~ "Endangered"))

master_desg <- left_join(cu_metadata, select(prob_desg, Region, du_number, per_change_recent, per_change_all, recent_abundance, last_year_monitored, prob_designation_recent,prob_designation_all), 
                     by="du_number") %>%
  mutate(COSEWIC_status_2023 = ifelse(is.na(COSEWIC_status_2023), "Not assessed", COSEWIC_status_2023)) %>%
  rename(Region = Region.x,
         COSEWIC_status = COSEWIC_status_2023) %>%
  mutate(region_full = case_when(
    Region == "HG" ~ "Haida Gwaii",
    Region == "CC" ~ "Central Coast",
    Region == "VIMI" ~ "Van. Isl. Main. Inl.",
    TRUE ~ Region))

# wrangle assessed and un-assessed status'
assessed <- master_desg %>%
  filter(COSEWIC_status != "Not assessed")

not_assessed <- master_desg %>%
  filter(COSEWIC_status == "Not assessed") %>%
  mutate(prob_designation_recent = ifelse(recent_abundance < 1000, "Threatened", 
                                          prob_designation_recent))%>%
  mutate(prob_designation_recent = ifelse(recent_abundance < 250, "Endangered", 
                                          prob_designation_recent)) %>%
  mutate(prob_designation_recent = ifelse(per_change_recent < -49, "Endangered", 
                                          prob_designation_recent)) %>%
  mutate(prob_designation_recent = ifelse(is.na(prob_designation_recent), "Data defficient", 
                                          prob_designation_recent),
         prob_designation_all = ifelse(is.na(prob_designation_all), "Data defficient", 
                                          prob_designation_all))

designations <- rbind(assessed,not_assessed)%>%
  mutate(species = spp) %>%
  select(region_full, DU_name_short, du_number,species, gen_length, COSEWIC_status,per_change_recent, per_change_all, recent_abundance, last_year_monitored, prob_designation_recent)%>%
  arrange(du_number)%>%
  distinct(du_number,.keep_all = TRUE)

unassessed <- designations %>%
  filter(COSEWIC_status == "Not assessed",
         prob_designation_recent != "Data defficient")

write.csv(designations, "./output/master-prob-status/master_status.csv", row.names=FALSE)

NA_regions <- filter(designations, is.na(region_full))
```

# Status summaries

## All DUs - plot

```{r summary-status-recent-all-dus, echo=FALSE, fig.align = "center", out.width = '90%'}

for(i in 1:length(designations$du_number)){
  if(designations$COSEWIC_status[i] == "Not assessed") {designations$status[i] <- designations$prob_designation_recent[i]}else{designations$status[i] <- designations$COSEWIC_status[i]}
  if(designations$status[i] == "Status assessment recommended"){designations$status[i] <- designations$prob_designation_recent[i]}
}

count_bins_status <- designations %>%
  group_by(species, region_full, status) %>%
  summarize(du_count=n()) %>%
mutate(status = factor(status, levels = rev(c("Extinct","Endangered","Threatened", "Special concern", "Not at risk", "Data defficient"))), 
         region_full = factor(region_full, levels = c("Yukon", "Nass","Skeena", "Haida Gwaii", "Central Coast", "Van. Isl. Main. Inl.", "Fraser"))) %>%
  drop_na(status, region_full)
  
count_bins_status[54,4] <- 1 # hard code Fraser pinks which have 8 DUs but only one CU

# plot status by spp and region for all DUs ----
ggplot(count_bins_status, aes(x = species, y = du_count)) + 
  geom_col(aes(fill=status)) +
  facet_wrap(~region_full, scales="free_y", ncol=4) +
  scale_fill_manual(values = c("grey","dark green", "yellow", "orange","red","black")) +
  xlab("Species") +
  ylab("Number of DUs") +
  labs(fill = "Probable designation") +
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1), legend.position = "top")
```

**Figure 1**. Status of all DUs. For DUs that have been previously assessed by COSEWIC the official status is shown, otherwise probable status is inferred based on percent change in mature individual abundance over the most recent three generations of data. DUs with absolute estimates of mature individuals less than 250 and 1000 are assigned a probable status of endangered and threatened, respectively (Criterion D).

## Unassessed DUs - plot

```{r summary-status-unassessed-dus, echo=FALSE, fig.align = "center", out.width = '90%', out.height = '60%'}
# summarize probable status by spp and region ----
count_bins <- unassessed %>%
  group_by(species, region_full) %>%
  summarize(du_count=n())

count_bins_status <- unassessed %>%
  group_by(species, region_full, prob_designation_recent) %>%
  summarize(du_count=n()) %>%
  mutate(prob_designation_recent = factor(prob_designation_recent, levels = rev(c("Endangered","Threatened", "Special concern", "Not at risk"))), 
         region_full = factor(region_full, levels = c("Yukon", "Nass","Skeena", "Haida Gwaii", "Central Coast", "Van. Isl. Main. Inl.", "Fraser"))) 

# plot probable status by spp and region ----
ggplot(count_bins_status, aes(x = species, y = du_count)) + 
  geom_col(aes(fill=prob_designation_recent)) +
  facet_wrap(~region_full, scales="free_y", ncol=4) +
  scale_fill_manual(values = c("dark green", "yellow", "orange","red")) +
  xlab("Species") +
  ylab("Number of DUs") +
  labs(fill = "Probable designation") +
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1), legend.position = "top")
```

**Figure 2**. Probable status of unassessed, but formally defined, Pacific salmon DUs (excluding those previously assessed by COSEWIC or recommended for status assessment) based on rate of change in mature individuals over most recent three generations.DUs with absolute estimates of mature individuals less than 250 and 1000 are assigned a probable status of endangered and threatened, respectively (Criterion D).

## All DUs - table

```{r, warning = FALSE}
colnames(designations) <- c("Region", "DU name", "DU no.", "Species", "Generation length", "COSEWIC status", "% Change (recent)", "% Change (all)", "Recent abundance", "Last year", "Probable status", "Status")

#switch characters to factor to make dropdown filtering
designations <- designations %>%
  mutate(Region = as.factor(Region), 
         'DU no.' = as.factor('DU no.'), 
         Species = as.factor(Species),
         `COSEWIC status` = as.factor(`COSEWIC status`),
         `Probable status` = as.factor(`Probable status`))
  
datatable(designations, rownames = FALSE, 
          caption = 'Table 1: Estimates of percent change in mature individual (spawner) abundance over most recent three generations (based on just last three generations or all years of observations) for Pacific Salmon DUs in the Pacific region. Also shown are the region, average generation length, COSEWIC status if previously assessed, mature individual abundance in most recent year with data, the last year with data, and probable COSEWIC designation based on percent change using just the last three generations of observations.',
          filter = 'top', 
          #extensions = 'Buttons',   #tradeoff if you uncomment these you can select which columns to see, 
          options = list(scrollX = TRUE, #^but you lose the pagelength option b/c too many buttons... 
                         pagelength = 10, 
                         #dom = 'Bfrtip',
                         #buttons = I('colvis'),
                         lengthMenu = c(10, 15, 20, 25)))
```

# Abundance plots

Plots of reconstructed number of mature individuals (spawners) over time for each DU, by region and species. Show are both raw and log(e) transformed estimates, and for the later the trend over the most recent three generations (red line) or entire time-series (black dashed line) are also shown.

```{r abundance plots, warning = FALSE, results= 'asis'}
#note: `asis` argument is necessary to properly render headers with cat() below

raw_sp_data <- raw_sp_data %>%
  mutate(logSp=log(Spawner.Abundance))


sp_data <- left_join(raw_sp_data, select(cu_metadata, CUID, du_number, DU_name_short,gen_length), 
                     by="CUID") %>%
  drop_na(du_number, Spawner.Abundance) %>%
  mutate(du_cu=paste(du_number, DU_name_short)) %>%
  relocate(du_cu, 1) %>%
  arrange(du_cu, Year) %>%
  mutate(Region = case_when(Region == "HG" ~ "Haida Gwaii",
                                 Region == "CC" ~ "Central Coast",
                                 Region == "VIMI" ~ "Van. Isl. Main. Inl.", 
                                 TRUE ~ Region)) 

regions_ordered <- c("Yukon", "Nass", "Skeena", "Haida Gwaii", "Central Coast", "Van. Isl. Main. Inl.", "Fraser", "Columbia")

last3_gens <- sp_data %>%
  group_by(du_cu) %>%
  mutate(three_gens = gen_length*3) %>%
  filter(Year > (last(Year) - three_gens), Year <= last(Year))

max_facets <- 20 #how many facets (i.e. panes) per plot?
rows <- 4 #how many rows/cols? note needs to be multiple of facets. 
cols <- 5

for(i in regions_ordered){
  sp_data_region <- filter(sp_data, Region==i)
  
   cat('\n')  
   cat("## ", i, "\n") #nested region header
   
  for(j in unique(sp_data_region$Species)){
    sub_data <- filter(sp_data_region, Species==j) %>%
      complete(Year, Species, Region, du_cu) #explicitly include NA so line draws right
    
    cat('\n')  
    cat("### ", j, "\n") #nested species within region header
    
    sub_last3 <- filter(last3_gens, Region==i, Species==j)
    n_pops <- length(unique(sub_data$du_cu))
    if( n_pops>max_facets){
      pages <- ceiling(n_pops/max_facets)
    for(k in 1:pages){
      sub_data_2 <- filter(sub_data, du_cu %in% 
                               unique(sub_data$du_cu)[((k-1)*max_facets)+1:(max_facets*k)])
      
      sub_last3_2 <- filter(sub_last3, du_cu %in% 
                                unique(sub_last3$du_cu)[((k-1)*max_facets)+1:(max_facets*k)])
      
      p <- ggplot(data = sub_data_2, aes(x=Year, y=Spawner.Abundance/1000)) +
        geom_line(color="grey") +
        geom_point() +
        ggh4x::facet_wrap2(vars(du_cu), nrow=rows, ncol=cols, trim_blank=FALSE,
                           scales="free_y") +
        labs(x="Year", y="spawners (thousands)", 
             title = paste0(i," ",j," spawner abundance ","(",k," of ",pages,")")) +
        theme_bw() +
        theme(strip.background=element_blank(), axis.text.x=element_text(angle=45), strip.text = element_text(size = 5))
      print(p)
      
      p_log <- ggplot(data=sub_data_2, aes(x=Year, y=logSp)) +
        geom_line(color="grey") +
        geom_point() +
        stat_smooth(method="lm", formula=y~x, color="black", lty="dashed", se=FALSE) +
        stat_smooth(data = sub_last3_2, formula=y~x, method="lm", color="red", se=FALSE, 
                    na.rm=TRUE) +
        ggh4x::facet_wrap2(vars(du_cu), nrow=rows, ncol=cols, trim_blank=FALSE,
                           scales="free_y") +
        labs(x="Year", y="ln(spawners)", 
             title=paste0("ln ",i," ",j," spawner abundance ","(",k," of ",pages,")")) +
        theme_bw() +
        theme(strip.background=element_blank(), axis.text.x=element_text(angle=45), strip.text = element_text(size = 5))
      print(p_log)
    }
  }else{
    p <- ggplot(data=sub_data, aes(x=Year, y=Spawner.Abundance/1000)) +
      geom_line(color="grey") +
      geom_point() +
      ggh4x::facet_wrap2(vars(du_cu), nrow=rows, ncol=cols, trim_blank=FALSE, 
                         scales="free_y") +
      labs(x="Year", y="spawners (thousands)", title=paste(i, j, "spawner abundance")) +
      theme_bw() +
        theme(strip.background=element_blank(), axis.text.x=element_text(angle=45), strip.text = element_text(size = 5))
    print(p)
    
    p_log <- ggplot(data=sub_data, aes(x=Year, y=logSp)) +
      geom_line(color="grey") +
      geom_point() +
      stat_smooth(formula=y~x, method="lm", color="black", lty="dashed", se=FALSE) +
      stat_smooth(data=sub_last3, formula=y~x, method="lm", color="red", se=FALSE, 
                  na.rm=TRUE) +
      ggh4x::facet_wrap2(vars(du_cu), nrow=rows, ncol=cols, trim_blank=FALSE, 
                         scales="free_y") +
      labs(x="Year", y="ln(spawners)", title=paste(i, j, "ln(spawner abundance)")) +
      theme_bw() +
        theme(strip.background=element_blank(), axis.text.x=element_text(angle=45), strip.text = element_text(size = 5))
    print(p_log)
  }
        cat('\n')  

  }
      cat('\n') 

}
```

# Future extensions

Running list of possible extensions: 

- switch to using Bayesian based estimates of percent decline from the [MetricsCOSEWIC]() repository once stable, consider incorporating cumulative probability and probability density associated percent change in table and abundance plots section of this summary document.

-   incorporate absolute abundance thresholds (Criterion C) into classification of probable status for those DUs with absolute abundance.

-   expand guidance and thinking around key considerations with respect to bundling/grouping high priority DUs (e.g., similar threats, magnitude of declines, etc.).

-   explore whether or not spatial considerations (Criterion B) based on index of area of occupancy can be calculated across DUs and be incorporated into assessment of probable status (or just be reported on). This mght present an opportunity to fold in traditional knowledge and spatial considerations.

-   consider whether an objective criteria could be developed to flag DUs that are candidates for emergency listings (e.g., if recent mature individuals falls way below recent average).
